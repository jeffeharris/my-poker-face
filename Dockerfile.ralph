FROM node:20-slim

# System dependencies
RUN apt-get update && apt-get install -y \
    python3 python3-pip python3-venv gcc curl git \
    && rm -rf /var/lib/apt/lists/*

# Claude Code CLI
RUN npm install -g @anthropic-ai/claude-code

# Python dependencies
WORKDIR /app
COPY requirements.txt .
RUN pip3 install --break-system-packages --no-cache-dir -r requirements.txt

# Create non-root user (Claude Code refuses --dangerously-skip-permissions as root)
RUN useradd -m -s /bin/bash ralph
RUN git config --global user.email "ralph@wiggum.bot" && \
    git config --global user.name "Ralph Wiggum" && \
    git config --global --add safe.directory /app

# Copy git config to ralph user
RUN cp /root/.gitconfig /home/ralph/.gitconfig && \
    chown ralph:ralph /home/ralph/.gitconfig

USER ralph
WORKDIR /app
CMD ["bash"]
